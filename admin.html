<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin: Upload Guidelines</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --border: #d0d7de;
      --text-main: #0f172a;
      --text-dim: #475569;
      --accent: #1d4ed8;
      --accent-text: #ffffff;
      --radius-lg: 0.75rem;
      --radius-sm: 0.5rem;
      --shadow-card: 0 20px 40px -8px rgba(15, 23, 42, 0.12);
      --code-bg: #0f172a;
      --code-fg: #e2e8f0;
    }

    body {
      background-color: var(--bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", Roboto, "Segoe UI", sans-serif;
      color: var(--text-main);
      line-height: 1.4;
      margin: 0;
      padding: 0;
    }

    header {
      padding: 1rem 1.25rem 0.5rem;
      font-weight: 600;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .logo-circle {
      background-color: var(--text-main);
      color: var(--card-bg);
      font-size: 0.8rem;
      font-weight: 600;
      line-height: 1;
      border-radius: 999px;
      padding: 0.6rem 0.6rem;
      font-family: ui-monospace, monospace;
      min-width: 2rem;
      text-align: center;
    }

    .header-text {
      display: flex;
      flex-direction: column;
    }
    .header-title {
      font-size: 1rem;
    }
    .header-sub {
      font-size: 0.8rem;
      font-weight: 400;
      color: var(--text-dim);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem 1rem 4rem;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-card);
      border: 1px solid rgba(15, 23, 42, 0.05);
      padding: 1rem 1rem 1.25rem;
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-main);
    }

    .muted {
      color: var(--text-dim);
      font-size: 0.85rem;
      line-height: 1.4;
      margin-top: 0;
    }

    .small {
      font-size: 0.8rem;
    }

    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem 1rem;
    }

    .input-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-bottom: 0.25rem;
      display: block;
      font-weight: 500;
    }

    input[type="text"],
    input[type="password"] {
      font-size: 0.9rem;
      padding: 0.6rem 0.6rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      min-width: 10rem;
      outline: none;
      background-color: #fff;
      color: var(--text-main);
    }

    input[type="file"] {
      font-size: 0.8rem;
    }

    button {
      appearance: none;
      border: 0;
      font-size: 0.9rem;
      line-height: 1.2rem;
      padding: 0.65rem 0.9rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
    }

    button.primary {
      background-color: var(--accent);
      color: var(--accent-text);
    }

    button.secondary {
      background-color: #fff;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    .log {
      background-color: var(--code-bg);
      color: var(--code-fg);
      font-family: ui-monospace, SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.8rem;
      line-height: 1.4;
      border-radius: var(--radius-sm);
      padding: 0.75rem 0.8rem;
      margin-top: 1rem;
      max-height: 200px;
      overflow-x: auto;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .guideline-box {
      border-top: 1px solid #d0d7de;
      padding-top: 0.75rem;
      margin-top: 0.75rem;
      font-size: 0.85rem;
      line-height: 1.4;
      color: #0f172a;
    }

    .danger-btn {
      background:#dc2626;
      border:0;
      color:#fff;
      border-radius:0.4rem;
      padding:0.4rem 0.6rem;
      font-size:0.8rem;
      cursor:pointer;
      margin-top:0.5rem;
    }

    footer {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: 2rem;
      margin-bottom: 3rem;
    }

    @media (max-width: 640px) {
      .input-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="logo-circle">CRC</div>
  <div class="header-text">
    <div class="header-title">Admin: Upload Guidelines</div>
    <div class="header-sub">PDF/DOCX or scanned images. OCR is supported.</div>
  </div>
</header>

<main class="container">

  <!-- CONNECTION CARD -->
  <section class="card">
    <h2>Connection</h2>
    <p class="muted small">Backend API Base URL and Admin Secret are stored locally in your browser only.</p>

    <div class="input-grid">
      <div>
        <label>Backend API Base URL</label>
        <input id="apiBase" type="text" placeholder="https://your-service.onrender.com" />
      </div>

      <div>
        <label>Admin Secret (must match server ADMIN_SECRET)</label>
        <input id="adminSecret" type="password" placeholder="••••••••" />
      </div>
    </div>
  </section>

  <!-- UPLOAD CARD -->
  <section class="card">
    <h2>Upload a Guideline</h2>

    <div class="input-grid">
      <div>
        <label>Title (e.g., NCCN Colon v2025)</label>
        <input id="titleInput" type="text" placeholder="NCCN Colon v2025" />
      </div>

      <div>
        <label>Document (PDF / DOCX / PNG / JPG / TIFF)</label>
        <input id="fileInput" type="file" />
      </div>

      <div>
        <label>OCR languages (comma-separated, e.g., eng or eng,chi_sim)</label>
        <input id="langInput" type="text" value="eng" />
      </div>
    </div>

    <div class="input-row">
      <button id="uploadBtn" class="primary">Upload &amp; Index</button>
      <button id="saveConnBtn" class="secondary">Save connection</button>
    </div>

    <pre id="log" class="log">No action yet.</pre>
  </section>

  <!-- LIST / DELETE CARD -->
  <section class="card">
    <h2>Current Guidelines in System</h2>
    <p class="muted small">
      Refresh to see all indexed guidelines. You can delete one guideline and rebuild the search index.
    </p>

    <div class="input-row">
      <button id="refreshBtn" class="secondary">Refresh guideline list</button>
    </div>

    <!-- Raw JSON debug -->
    <pre id="listLog" class="log">No data loaded yet.</pre>

    <!-- Friendly list with delete buttons -->
    <div id="guidelineList" style="
      margin-top:1rem;
      border:1px solid #d0d7de;
      border-radius:0.5rem;
      background:#fff;
      padding:0.75rem;
      font-size:0.85rem;
      line-height:1.4;
      color:#0f172a;
    ">
      <div style="color:#475569;">No guidelines yet.</div>
    </div>
  </section>

</main>

<footer>
  © 2025 CRC Guidance
</footer>

<script>
  // DOM refs
  const apiBaseEl = document.getElementById('apiBase');
  const secretEl = document.getElementById('adminSecret');
  const titleEl = document.getElementById('titleInput');
  const fileEl = document.getElementById('fileInput');
  const langEl = document.getElementById('langInput');
  const logEl = document.getElementById('log');

  const saveConnBtn = document.getElementById('saveConnBtn');
  const uploadBtn = document.getElementById('uploadBtn');

  const refreshBtn = document.getElementById('refreshBtn');
  const listLog = document.getElementById('listLog');
  const guidelineList = document.getElementById('guidelineList');

  // Load saved connection info
  function loadConnection() {
    const savedBase = localStorage.getItem('API_BASE') || '';
    const savedSecret = localStorage.getItem('ADMIN_SECRET') || '';
    if (savedBase) apiBaseEl.value = savedBase;
    if (savedSecret) secretEl.value = savedSecret;
  }
  loadConnection();

  // Save connection info
  saveConnBtn.onclick = () => {
    const baseVal = apiBaseEl.value.trim();
    const secVal = secretEl.value.trim();
    localStorage.setItem('API_BASE', baseVal);
    localStorage.setItem('ADMIN_SECRET', secVal);
    setLog('Saved connection settings.');
  };

  // helper to set upload log
  function setLog(obj) {
    if (typeof obj === 'string') {
      logEl.textContent = obj;
    } else {
      logEl.textContent = JSON.stringify(obj, null, 2);
    }
  }

  // Upload guideline
  uploadBtn.onclick = async () => {
    const apiBase = (apiBaseEl.value || '').trim();
    const adminSecret = (secretEl.value || '').trim();
    const title = (titleEl.value || '').trim();
    const langs = (langEl.value || '').trim();
    const file = fileEl.files[0];

    if (!apiBase || !adminSecret || !title || !file) {
      setLog({ error: 'Missing required fields (url, secret, title, file)' });
      return;
    }

    const formData = new FormData();
    formData.append('secret', adminSecret);
    formData.append('title', title);
    formData.append('langs', langs || 'eng');
    formData.append('file', file);

    setLog('Uploading...');

    try {
      const resp = await fetch(apiBase + '/api/upload', {
        method: 'POST',
        body: formData
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        setLog({ error: 'Upload failed', status: resp.status, data });
        return;
      }

      setLog(data);
    } catch (err) {
      setLog({ error: 'Network error', detail: String(err) });
    }
  };

  // Escape helpers for safe HTML
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function escapeAttr(str) {
    return String(str)
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // Delete one guideline by sourceId
  async function deleteGuideline(sourceId) {
    const apiBase = (apiBaseEl.value || localStorage.getItem('API_BASE') || '').trim();
    const adminSecret = (secretEl.value || localStorage.getItem('ADMIN_SECRET') || '').trim();

    if (!apiBase || !adminSecret) {
      alert('Missing API base URL or Admin Secret.');
      return;
    }

    const url = apiBase + '/api/source/' + encodeURIComponent(sourceId) +
      '?secret=' + encodeURIComponent(adminSecret);

    try {
      const resp = await fetch(url, { method: 'DELETE' });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        alert('Delete failed:\n' + JSON.stringify(data, null, 2));
        return;
      }

      alert('Deleted guideline: ' + sourceId);
      await loadGuidelines(); // refresh after delete
    } catch (err) {
      alert('Network error while deleting guideline.');
    }
  }

  // Load guidelines and render list
  async function loadGuidelines() {
    const apiBase = (apiBaseEl.value || localStorage.getItem('API_BASE') || '').trim();

    if (!apiBase) {
      listLog.textContent = 'Please set and save connection first.';
      guidelineList.innerHTML = '<div style="color:#ef4444;">No API base URL set.</div>';
      return;
    }

    listLog.textContent = 'Loading...';
    guidelineList.innerHTML = '<div style="color:#475569;">Loading...</div>';

    try {
      const res = await fetch(apiBase + '/api/sources');
      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        listLog.textContent = 'Error:\n' + JSON.stringify(data, null, 2);
        guidelineList.innerHTML = '<div style="color:#ef4444;">Error loading guidelines.</div>';
        return;
      }

      // Show raw JSON for debugging
      listLog.textContent = JSON.stringify(data, null, 2);

      // Build pretty list
      if (!data.guidelines || data.guidelines.length === 0) {
        guidelineList.innerHTML = '<div style="color:#475569;">No guidelines yet.</div>';
        return;
      }

      let html = '';
      data.guidelines.forEach(g => {
        html += `
          <div class="guideline-box">
            <div><strong>Title:</strong> ${escapeHtml(g.title || '')}</div>
            <div><strong>Source ID:</strong> <code>${escapeHtml(g.sourceId || '')}</code></div>
            <div><strong>File:</strong> ${escapeHtml(g.filename || '')}</div>
            <div><strong>Uploaded:</strong> ${escapeHtml(g.uploadedAt || '')}</div>
            <div><strong>Lang guess:</strong> ${escapeHtml(g.lang || '')}</div>
            <div><strong>Chunks:</strong> ${g.chunks ?? 0}</div>
            <button
              class="danger-btn"
              data-sourceid="${escapeAttr(g.sourceId || '')}"
            >
              Delete this guideline
            </button>
          </div>
        `;
      });

      guidelineList.innerHTML = html;

      // Attach delete handlers
      guidelineList.querySelectorAll('.danger-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const sid = btn.getAttribute('data-sourceid');
          const confirmDelete = confirm(
            'Are you sure you want to delete this guideline from the index?\n\n' +
            sid +
            '\n\nThis cannot be undone.'
          );
          if (!confirmDelete) return;

          await deleteGuideline(sid);
        });
      });

    } catch (err) {
      listLog.textContent = 'Network error trying to reach /api/sources';
      guidelineList.innerHTML = '<div style="color:#ef4444;">Network error.</div>';
    }
  }

  // Wire Refresh button
  refreshBtn.onclick = loadGuidelines;
</script>
</body>
</html>
